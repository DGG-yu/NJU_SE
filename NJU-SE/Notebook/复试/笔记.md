

## 高性能

规范化的价值：

* 合理规范化的模型可应对需求变更
* 规范化数据重复率降至最少

对于🈳️值

* 存在空值动摇查询优化的基础
* 必须使用空值的话，一定要清楚它们在特定情况下的影响

使用Boolean字段：

* SQL不存在Boolean字段

约束应该明确说明：

* 数据中存在隐含约束是一种不良设计

保持数据库Schema稳定

* 任何对数据字典的操作都会引起全局加锁，对系统性能影响巨大

* 不应该在应用程序中进行数据库对象的建立/修改和删除等操作

Sql

* Sql完全基于集合来处理数据
* 不是过程性语句
* 避免在sql中引入“过程逻辑”

充分利用每一次数据库访问

* 从⼀个表中提取多段信息，采⽤多次数据库访问的⽅法⾮常糟糕
* 在合理的范围内，利用每次数据库访问完成尽量多的工作



## 索引

* 索引也有可能降低查询性能

* 磁盘空间的开销/处理开销

* 索引的使用是否合理，首先取决于它是否有用

* 判断索引适⽤用性的依据是检索⽐率(retrieval ratios)

* 什么时候应该使⽤B树索引

  * 仅当要通过索引访问表中**很少⼀部分⾏**
  * 如果要处理表中多行，而且可以使用索引而不用表

* B树索引的适用范围

  * 全值匹配
  * 匹配最左前缀
  * 匹配列前缀
  * 匹配范围值
  * 精确匹配某⼀列并范围匹配另外一列
  * 只访问索引的查询

* B树索引的限制

  * 如果不是按照索引的最左列开始查找，则⽆法使用索引

  * 不能跳过索引中的列

    * Key(last_name, first_name, dob)

    * ⽆法用于查找姓为Smith并且在某个特定日期出生的⼈

  * 如果查询中有某个列的范围查询，则其右边所有列列都⽆法使用索引优化查找

    * 例如:Where last_name=‘Smith’ And first_name Like ‘J%’ AND dob=‘1976-4-25’, 
    * 这个查询只能使⽤用索引的前两列列，因为Like是⼀一个范围条件
    * 可以使⽤用多个等于条件代替范围条件

  * 所以:索引列的顺序是最重要的关注点

* Hash索引

  * 在MySQL中，只有Memory引擎显性⽀支持哈希索引
  * 这也是Memory引擎的默认索引类型
  * 与众不同的是，Memory引擎支持非唯⼀哈希索引
  * 哈希索引的限制：
    * 只包含哈希值和行指针，而不存储字段值
    * 无法按照索引值顺序排序
    * 不支持部分索引列匹配查找
    * 只⽀持等值比较查询，包括=、IN()、<=>
    * 访问哈希索引的数据非常快，除非有很多哈希冲突
    * 哈希冲突很多的时候，索引维护代价也很⾼
  * 适用范围
    * 只适用于特定场合，一旦使用，性能提升显著
    * 数据仓库的星型schema
    * InnoDB引擎有一个特殊功能叫“自适应哈希索引”，当某些索引值被使用得非常频繁时，会在内存中基于B-tree索引之上再创建一个哈希索引

* 索引列选择需要注意的问题：

  * 一个复合键索引应付更多的状况
  * 可选择性的列未必是唯一的指标
  * 将范围检索放在最后
  * 避免出现多个范围检索
  * 用IN()替代范围检索

* 系统生成键

  * 系统生产序列号，远好于
    * 寻找当前最大值并加1
    * 用一个专用表保存”下一个值“且加锁更新
  * 但如果插入并发性过高，在主键索引的创建操作上会发生十分严重的资源竞争
  * 解决方案：
    * 反向键索引或逆向索引
    * 哈希索引

 ## 查询优化

* 优化时在数据处理真正被执行时发生的
  * 索引/数据的物理布局/可用内存大小/可用处理器个数/直接或间接涉及的表和索引的数据量
* SQL执行顺序
  * 语法
  * 语义
  * 解析：
    * 硬解析
    * 软解析
  * 执行计划
* 优化器的有效范围
  * 需要借助数据库中找到的信息
  * 能够进行数学意义上的等价变换
  * 优化器考虑整体相应时间
  * 优化器改善的是独立的查询
* 一些原则：
  * 避免在最高层使用distinct
    * 使用 EXISTS 或 IN 替代
  * 越快剔除不需要的数据，查询的后续阶段必须处理的数据量越少，查询效率就越高
    * Group by & having 子句：
      * 所有影响聚合函数结果的条件都应在Having子句
      * 任何无关聚合条件都应该放在where子句
      * 减少Group by 必须执行排序操作所处理的数据量
  * 将子查询转换为JOIN（不包含聚合函数，不出现多种条件选择则不需要子查询）

## 物理实现

* 