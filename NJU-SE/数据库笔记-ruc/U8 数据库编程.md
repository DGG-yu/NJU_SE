---
title: 第八单元 数据库编程
date: 2019-09-09 15:03:10
categories: 幽邃研路
tags: [考研,人大855,数据库]
---
本章讲解如何在应用程序中使用编程方法对数据库进行操纵  
SQL是非过程化的查询语言，而高度非过程化导致它缺少流程控制能力，难以实现应用业务中的逻辑控制。**SQL编程技术可以有效克服SQL语言实现复杂应用方面的不足，提高应用系统和数据库管理系统间的互操作性**  
### 8.1 嵌入式SQL
嵌入式SQL：将SQL语言嵌入程序设计语言中  
主语言：被SQL嵌入的语言  
<!--more--> 
嵌入式SQL的处理过程：
```
graph TD
含嵌入式是SQL的主语言程序-->DBMS预处理程序转换嵌入式SQL语句为函数调用
DBMS预处理程序转换嵌入式SQL语句为函数调用-->主语言编译程序编译处理成目标码
```

当写代码的时候，嵌入式SQL语句前面需要加前缀：  
- C语言：EXEC <SQL语句>
- JAVA语言：#SQL {<SQL语句>}  

#### 8.1.2 嵌入式SQL语言与·主语言之间的通信 
数据库工作单元和源程序工作单元之间的通信主要包括：  
1. 向主语言传递SQL语句的执行状态信息，使得主语言能够据此信息控制程序流程，主要用SQL通信区实现
2. 主语言向SQL语句提供参数，主要用主变量实现
3. 将SQL语句查询数据库的结果交给主语言处理，主要用主变量和游标实现

##### 1. SQL通信区
功能：语句SQL执行之后，系统要反馈给应用程序若干信息，主要包括描述系统当前工作状态和运行环境的各种数据。这些信息将送到SQL通信区中  
使用方法：
- SQL通信区再应用程序中使用EXEC SQL INCLUDE SQLCA来定义
- SQL通信区中有一个变量叫做SQLCODE，用于存放每次执行SQL语句后返回的代码  
- 当SQL语句成功执行时，SQLCODE等于预定义的常量SUCCESS    
- 每跑一条SQL语句，应用程序就应该检测一下SQLCODE  

##### 2. 主变量
主变量：SQL语句可以使用主语言程序变量来输入或者输出信息  
分类：  
- 输入主变量
    - 应用程序对其赋值，SQL语句引用
- 输出主变量
    - SQL语句对其赋值或设置状态信息，返回给应用程序

指示变量
- 一个主变量可以附带一个任选的指示变量
- 一个指示变量是一个整型变量，用来“指示”（标明）所指主变量的值或条件
    - 比如指示输入/输出主变量是否为空值等
- 使用
    - 所有著变量和指示变量都必须在BEGIN DECLARE SECTION 和 END DECLARE SECTION之间进行说明。
    - 说明之后，主变量可在SQL中任何一个需要使用表达式的地方出现
    - SQL语句中的主变量名和指示变量前要加冒号（：）作为标志

##### 3. 游标
游标是系统为用户开设的一个数据缓冲区  
解决问题：解决SQL和应用程序的处理方式不同的问题。SQL是面向集合的，一条SQL语句可以产生或处理多条记录，而一组主变量一次只能存放一条记录，因此使用主变量并不能完全满足SQL语句像应用程序输出数据的要求

##### 4. 建立和关闭数据库连接
嵌入式SQL要访问数据库就要先连接数据库，DBMS根据用户信息对连接请求进行合法性验证，通过来身份验证才能创建一个可用的合法连接  
1. 建立数据库连接  
    - 语句写法：EXEC SQL CONNECT TO target[AS connection-name][USER user-name]
    - 说明：
        - target是要连接的数据库服务器
        - connection-name是可选的连接名，用于识别一个程序内同时建立的多个连接，若整个程序内只有一个连接，就可以不指定连接名
2. 修改连接
    - 如果一个程序建立了多个连接，执行的所有数据库单元的操作都在该操作提交时所选择的当前连接上，因此程序运行时可以修改当前连接
    - 语句写法：EXEC SQL SET CONNECTION connection-name|DEFAULT;
3. 关闭数据库连接
    - 语句写法：EXEC SQL DISCONNECT [connection];  

#### 8.1.3 不用游标的SQL语句
##### 1. 查询结果为单记录的SELECT语句
由于查询结果是单个记录，因此直接在SELECT语句中使用INTO子句放入主变量之中  
说明：  
- INTO WHERE子句 HAVING短语的条件表达式中都可以使用主变量
- 当初查询而得出的某个数据项为空值时，系统会自动将相应主变量后面的指示变量置为负值，而不再向该主变量赋值  
- 如果查询结果十多条记录，程序会出错

##### 2. 非CURRECT形式的增删改语句
有些非CURRECT形式的曾删改语句不用使用游标，再UPDATE的SET子句和WHERE子句中可以使用主变量，SET子句还可以使用指示变量  

#### 8.1.4 使用游标的SQL语句
##### 1. 查询结果为多条记录的SELECT语句
此时，使用游标机制将查询出来的u多条记录一次一条的送欸主程序处理，从而把对集合的操作转换为对单个记录的处理  
###### 使用步骤
1. 说明游标
语句写法： EXEC DECLARE <游标名> CURSOR FOR <SELECT语句>  
**定义游标仅仅是一条说明性语句，这是关系数据库系统并不执行SELECT语句**  
2. 打开游标
- 语句写法：EXEC SQL OPEN<游标名>
- 操作意义：打开游标就是执行对应的SELECT语句，把查询结果取到缓冲区之中。这是游标处于活动状态，指针指向拆线呢结果集的第一条记录
3. 推进油表指针并取当前记录
- EXEC SQL FETCH <游标名> INTO <主变量>[<指示变量>][,<主变量>[<指示变量>]]...  
- 将缓冲区中的当前变量存入主变量之中，同时将右边向前推进一条记录  
4. 关闭游标
- EXEC SQL CLOSE <游标名>;
- 关闭后会释放游标所占用的缓冲区和其他资源，不在和原来的拆线呢结果集相联系，但是关闭的游标可以再打开，核心的查询结果相联系  

##### 2. CURRENT形式的UPDATE和DELETE语句
- 理解：CURRENT形式指的就是实现定点增删，UPDATE和DELETE语句都是集合操作，如果只想修改或者删除其中的某个记录，则需要用带游标的SELECT语句查找出全部符合条件的记录，然后在其中找到要修改和删除的记录，然后用CURRENT形式的UPDATE和DELETE语句修改或删除
- 语句写法：在UPDATE或者DELETE语句中加上：WHERE CURRENT OF <游标名>  
- 表示修改或删除的是最近一次取出的记录  

#### 8.1.5 动态SQL
前面所讲的都是静态SQL语句：砌筑变量，查询目标列，条件都是固定的  
动态SQL语句：  
- 解决问题：某些应用要到执行时才能够确定要提交的SQL语句、查询的条件
- 有两种形式
    - 动态组装SQL语句
    - 动态参数

##### 1. 使用SQL语句主变量
SQL语句主变量：程序主变量包含的内容是SQL语句，而不是原来保存数据的，输入或输出变量
SQL语句主变量在程序执行期间可以设置成不同的SQL语句，然后立即执行（是然后而不是这值得当时）  

##### 2. 动态参数 
- 含义：动态参数是SQL语句中的可变元素，动态参数的数据在运行时设定  
- 表示方法：使用参数符号 **（?）**  
- 特点：动态参数的输入不是编译时完成绑定，而是通过**PREPARE语句**准备主变量和**执行语句EXECUTE**绑定数据或主变量来完成
- 使用步骤：
    1. 声明SQL语句主变量：这个主变量的值要包含动态参数（?）
    2. 准备SQL语句（PREPARE）
        - PREPARE将会分析含主变量的SQL语句的内容，建立语句中包含的动态参数的内部描述符，并用<语句名>来标识他们的整体
        - 语句格式：EXEC SQL PREPARE <语句名> FROM <SQL语句主变量>
    3. 执行准备好的语句（EXECUTE)
        - EXECUTE将SQL语句中分析出的动态参数和主变量或数据常量绑定，作为语句的输入或者输出变量

(貌似是，首先声明一个SQL语句主变量，里面使用了动态参数，这个动态参数在使用PREPARE语句之后，就会在内部被视为一个主变量，而在外部则有一个语句名作为全部动态参数的入口，在执行的时候，被视为内部主变量的动态参数，它回和外边的一个主变量或者常数绑定，从而直接变成外边的变量)      

### 8.2 过程化SQL
#### 8.2.1 过程化SQL的块结构
SQL的分类：
- 基本的SQL：高度非过程化的
- 嵌入式SQL：利用其它程序设计语言来实现过程化
- 过程化SQL：对于SQL的拓展，使其增加了过程化语句的功能

过程化SQL的基本结构是块，每个块完成一个逻辑操作，块和块之间可以相互嵌套，多个块组成过程化SQL程序  

#### 8.2.2 变量和常量的定义
##### 1. 变量的定义
变量名 数据类型 [[NOT NULL]:=初值表达式] 或  
变量名 数据类型 [[NOT NULL] 初值表达式]  

##### 2。常量的定义
常量名 数据类型 CONSTANT:=常量表达式  
注意：常量必须要给定一个之并且该址在存在期间或常量的作用域内不可改变  

##### 3. 赋值语句
变量名:=表达式  

#### 8.2.3 流程控制
过程化SQL提供了流程控制语句，主要有条件控制语句和循环控制语句  
不同产品语句语法不同（那就是非重点了估计）    
##### 1. 条件控制语句
IF-THEN、IF-THEN-ELSE、嵌套的IF语句   
##### 2. 循环控制语句
1. LOOP
    - LOOP本身是个死循环，里面需要搭配循环结束语句使用
2. WHILE-LOOP
    - 执行循环之前进行条件判断
3. FOR-LOOP
    - 这里的FOR循环自带循环变量，貌似不能使用外边的变量
##### 3. 错误处理

### 8.3 存储过程和函数
过程化SQL块分为：
- 匿名块
    - 上边讲的都是匿名块
    - 特点：
        - 匿名块每次执行时都需要重新编译
        - 无法存储到数据库中
        - 不能再其他过程化SQL块中调用
- 命名块
    - 存储过程和函数都是命名块
    - 被编译后保存在数据库中，称为持久性存储模块

#### 8.3.1 存储过程
概念：存储过程是由过程化SQL语句书写的过程，这个过程经编译和优化后存储在数据库服务器中，因此称他为存储过程  
##### 1。 存储过程的优点
1. 运行效率高
    - 它不像解释执行的SQL语句那样在提出操作请求时才进行语法分析和优化工作，因而运行效率高，他提供了在服务器端快速执行SQL语句的有效途径  
2. 存储过程降低了客户机和服务器之间的通信量
    - 客户机上的应用程序只要通过网络向服务器发出调用存储过程的名字和参数，就可以让DBMS执行其中的多条SQL语句并进行数据处理。只有最终的处理结果才返回客户端  
3. 方便实施企业规则
    - 可以把企业规则的运算程序写进存储过程放入数据库服务器之中，由DBMS进行管理，既有利于集中控制，有嫩俄国狗方便的进行维护。当企业规则发生变化时只要修改存储过程即可，无需修改其他应用程序  
##### 2. 存储过程的用户接口
###### 1. 创建存储过程
CREATE OR REPLACE PROCEDURE 过程名 （[参数1，参数2，...]）  
AS <过程化SQL块>  
说明：
- 参数列表中，可以定义输入参数、输出参数、输入/输出参数，也可以无参数  
- 过程提结构和匿名块完全一样，（匿名块看来是最小单位233）

##### 2. 执行存储过程
CALL/PERFORM PROCEDURE 过程名([参数1，参数2，...]);  
在存储过程体中，可以调用其他存储过程  

##### 3. 修改存储过程
1. 重命名
     - ALTER PROCEDURE 过程名1 RENAME TO 过程名2;  
2. 重新编译
    - ALTER PROCEDURE 过程名 COMPILE;  

##### 4. 删除存储过程
DROP PROCEDURE 过程名();  

#### 8.3.2 函数
本章所讲解的函数又称为**自定义函数**，因为是用户自己使用过程化SQL设计定义的，函数和存储过程各个方面都基本类似，都是持久性存储模块，不同之处在于函数必须指定返回的类型  
##### 1. 函数的定义语句格式
CREATE OR REPLACE FUNCTION 函数名([参数1,参数2,...]) RETURNS <类型>  
AS <过程化SQL块>  
##### 2. 函数的执行
CALL/SELECT 函数名([参数1,参数2,...]);  
##### 3. 修改函数
- 重命名
    - ALTER FUNCTION 过程名1 RENAME TO 过程名2  
- 重新编译
    - ALTER FUNCTION 函数名 COMPILE; 

### 8.4 ODBC编程
优点：使用ODBC编写的程序可移植性好，能同时访问不同的数据库，共享多个数据资源
OPBC是微软推出的接口标准，它建立了一组规范  
#### 8.4.1 ODBC概述
产生ODBC的原因：存在不同的DBMS  
目的：使数据库系统开放，实现开放互联  
#### 8.4.2 ODBC工作原理概述  
体系结构：用户应用程序、ODBC驱动程序管理器、数据库驱动程序、数据源  
1. 用户应用程序
    - 提供用户界面、应用逻辑和事务逻辑
2. ODBC驱动程序管理器
    - 用于管理各种驱动程序
    - 可以简历里、配置或者删除程序员
3. 数据库驱动程序
    - 提供应用程序和数据库平台的独立性
    - ODBC应用程序的操作请求有驱动程序管理器提交给某个DBMS的ODBC的驱动程序。通过调用驱动程序所支持的函数来存取数据库  
    - 驱动程序隔绝了各个数据库之间的差异，应用程序只要可以直接和驱动程序沟通就行了
4. ODBC数据源管理
    - 数据源是最终用户所需要访问的数据，是一种数据连接的抽象  

#### 8.4.3 ODBC API基础
ODBC API要满足两方面的一致性：  
- API一致性
- 语法一致性
##### 1. 函数概述
ODBC 3.0 标准提供了76个函数接口，分为：  
- 分配和释放环境句柄、连接句柄、语句句柄
- 连接函数
- 与信息相关的函数
- 事务处理函数
- 执行相关函数
- 编目函数
##### 2. 句柄及其属性
句柄是32位整数值，代表一个指针  
句柄分类：  
- 环境句柄：每个ODBC应用程序都要建立一个，存取数据的全局背景
- 连接句柄：一个连接句柄实现一个与数据源的连接
- 语句句柄：指一个SQL语句，还包括SQL语句产生的结果集以及相关的信息等  
- 描述符句柄：秩相描述SQL语句的参数、结果集列的元数据集合
##### 3. 数据类型
ODBC定义了两套数据类型，即SQL数据类型和C数据类型。
- C-->SQL：应用程序变量传送到语句参数
- SQL-->C：从结果集列返回到应用程序

#### 8.4.4 ODBC的工作流程
1. 配置数据源
    - 把数据库变成数据源，里面写了和他相关的驱动程序
2. 初始化环境
    - 在应用程序里面对于两个数据库都创建了对应的环境句柄，但是由于应用程序还没和具体的驱动程序相关联，所以用DRIVER MANAGER来管理并配置环境属性（也就是此时环境句柄为空呗），当应用程序和某个数据源进行连接后，对应的驱动程序才会真正为环境句柄分配数据结构  
3. 建立连接
4. 分配语句句柄
5. 执行SQL语句
6. 结果集处理
7. 中止处理


